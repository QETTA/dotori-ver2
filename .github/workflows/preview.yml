# ── Dotori PR Preview Deployments ──
# Creates preview apps for PRs, cleans up on close
# GitHub Pro: deployment environment로 staging 시크릿 분리
# Ref: https://github.com/digitalocean/app_action

name: PR Preview

concurrency:
  group: dotori-preview-${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'reference/**'
  # cleanup은 별도 트리거 — paths-ignore 없이 모든 close에서 실행
  pull_request_target:
    branches: [main]
    types: [closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ── Deploy preview on PR open/update ──
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: staging
      url: ${{ steps.url.outputs.preview_url }}
    steps:
      - uses: actions/checkout@v6

      - name: Deploy PR preview
        id: deploy
        timeout-minutes: 10
        continue-on-error: true
        uses: digitalocean/app_action/deploy@v2
        with:
          deploy_pr_preview: "true"
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Extract preview URL
        id: url
        if: steps.deploy.outcome == 'success'
        run: |
          URL=$(echo '${{ steps.deploy.outputs.app }}' | python3 -c "import sys,json; print(json.load(sys.stdin).get('live_url',''))" 2>/dev/null || echo "Preview URL unavailable")
          echo "preview_url=$URL" >> $GITHUB_OUTPUT
          
          SOURCE_COMMIT=$(echo '${{ steps.deploy.outputs.app }}' | python3 -c "import sys,json; print((json.load(sys.stdin).get('active_deployment',{}).get('services') or [{}])[0].get('source_commit_hash',''))" 2>/dev/null || echo "")
          if [ -z "$SOURCE_COMMIT" ]; then
            SOURCE_COMMIT=$(echo '${{ steps.deploy.outputs.app }}' | python3 -c "import sys,json; print((json.load(sys.stdin).get('services') or [{}])[0].get('source_commit_hash',''))" 2>/dev/null || echo "")
          fi
          echo "source_commit=$SOURCE_COMMIT" >> $GITHUB_OUTPUT

      - name: Fail if preview URL is missing
        if: steps.deploy.outcome == 'success'
        run: |
          if [ "${{ steps.url.outputs.preview_url }}" = "Preview URL unavailable" ] || [ -z "${{ steps.url.outputs.preview_url }}" ]; then
            echo "Preview URL is unavailable"
            exit 1
          fi

      - name: Wait for preview health
        if: steps.deploy.outcome == 'success'
        id: health
        run: |
          BASE_URL="${{ steps.url.outputs.preview_url }}"
          BASE_URL="${BASE_URL%/}"
          HEALTH_URL="${BASE_URL}/api/health"
          for i in $(seq 1 90); do
            if curl -fsS --max-time 5 "$HEALTH_URL" >/dev/null 2>&1; then
              echo "preview_health=$HEALTH_URL" >> $GITHUB_OUTPUT
              echo "Preview health ready in ${i}s: $HEALTH_URL"
              exit 0
            fi
            sleep 2
          done
          echo "Preview health check timeout: $HEALTH_URL"
          exit 1

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.url.outputs.preview_url }}
          PREVIEW_HEALTH_URL: ${{ steps.health.outputs.preview_health }}
          PREVIEW_SOURCE_COMMIT: ${{ steps.url.outputs.source_commit }}
          PREVIEW_HEAD_COMMIT: ${{ github.event.pull_request.head.sha }}
        with:
          script: |
            const url = process.env.PREVIEW_URL;
            const healthUrl = process.env.PREVIEW_HEALTH_URL;
            const sourceCommit = process.env.PREVIEW_SOURCE_COMMIT
              ? process.env.PREVIEW_SOURCE_COMMIT.substring(0, 7)
              : 'unknown';
            const headCommit = process.env.PREVIEW_HEAD_COMMIT
              ? process.env.PREVIEW_HEAD_COMMIT.substring(0, 7)
              : `${context.sha.substring(0, 7)}`;
            const body = [
              '### Preview Deployment',
              '',
              `**URL**: ${url}`,
              `**Health**: ${healthUrl}`,
              `**Source Commit**: \`${sourceCommit}\``,
              `**PR Head SHA**: \`${headCommit}\``,
              '',
              `Deployed: ${new Date().toISOString()}`,
              `Run SHA: \`${context.sha.substring(0, 7)}\``,
              `[Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('### Preview Deployment')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            }

      - name: Comment on failure
        if: always() && steps.deploy.outcome != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Preview deployment failed. [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
            });

      - name: Mark preview job failed when deploy action fails
        if: steps.deploy.outcome != 'success'
        run: exit 1

  # ── Cleanup preview on PR close (항상 실행, paths-ignore 없음) ──
  cleanup:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Delete preview app
        uses: digitalocean/app_action/delete@v2
        with:
          from_pr_preview: "true"
          ignore_not_found: "true"
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
