# ── Dotori Deploy — Manual Only (workflow_dispatch) ──
# doctl auth init 401 버그 → curl 직접 호출로 전면 교체 (R51)
# 원인: doctl이 PAT(dop_v1_)를 OAuth 엔드포인트(cloud.digitalocean.com)로 검증 → 항상 401
# 해결: DO REST API(api.digitalocean.com)를 curl로 직접 호출
#
# 실행 방법:
#   1. GitHub Actions UI → "Deploy" → "Run workflow"
#   2. CLI: gh workflow run deploy.yml

name: Deploy

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild (skip SHA cache)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read

concurrency:
  group: dotori-deploy
  cancel-in-progress: false

env:
  DO_APP_ID: 29a6e4f6-b8ae-48b7-9ae3-3e3275b274c2
  DO_API: https://api.digitalocean.com/v2

jobs:
  # ── Gate: CI must pass before deploy ──
  ci-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI and verify pass
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Waiting for CI on ${GITHUB_SHA::7}..."
          for attempt in $(seq 1 30); do
            RESULT="$(gh run list --repo "${{ github.repository }}" --workflow CI --branch main --limit 10 --json headSha,status,conclusion)"
            STATUS="$(echo "$RESULT" | python3 -c "
          import json,sys
          runs = json.load(sys.stdin)
          target = next((r for r in runs if r.get('headSha','').strip() == '${GITHUB_SHA}'.strip()), None)
          if not target: print('MISSING'); sys.exit(0)
          if target.get('status') != 'completed': print('PENDING'); sys.exit(0)
          print(target.get('conclusion','unknown'))
          ")"
            case "$STATUS" in
              success) echo "CI gate passed (attempt $attempt)"; exit 0 ;;
              PENDING) echo "CI pending... (attempt $attempt/30, wait 10s)"; sleep 10 ;;
              MISSING)
                if [ "$attempt" -ge 30 ]; then
                  echo "::error::No CI run found after 5 minutes"
                  exit 1
                fi
                echo "CI not found yet... (attempt $attempt/30, wait 10s)"; sleep 10 ;;
              *) echo "::error::CI failed ($STATUS)"; exit 1 ;;
            esac
          done
          echo "::error::CI did not complete in 5 minutes"; exit 1

  deploy:
    needs: [ci-gate]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production
      url: ${{ steps.app.outputs.url }}
    env:
      DO_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate DO token
        run: |
          HTTP_CODE="$(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: Bearer ${DO_TOKEN}" \
            "${DO_API}/account")"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::DO API token invalid (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "DO token validated (HTTP 200)"

      - name: Verify app exists and get spec
        run: |
          APP_JSON="$(curl -sf \
            -H "Authorization: Bearer ${DO_TOKEN}" \
            "${DO_API}/apps/${DO_APP_ID}")"
          if [ -z "$APP_JSON" ]; then
            echo "::error::App not found"
            exit 1
          fi
          # Verify source mode (not image)
          echo "$APP_JSON" | python3 -c "
          import json, sys
          app = json.load(sys.stdin).get('app', {})
          spec = app.get('spec', {})
          svc = next((s for s in (spec.get('services') or []) if s.get('name') == 'web'), None)
          if not svc:
              print('ERROR: service web not found', file=sys.stderr); sys.exit(1)
          if svc.get('image'):
              print('ERROR: image mode configured', file=sys.stderr); sys.exit(1)
          gh = svc.get('github') or {}
          if gh.get('repo') != 'QETTA/dotori-ver2' or gh.get('branch') != 'main':
              print('ERROR: source not pinned to QETTA/dotori-ver2@main', file=sys.stderr); sys.exit(1)
          print('OK: app spec validated (source mode, QETTA/dotori-ver2@main)')
          "

      - name: Check if SHA already deployed
        id: active
        run: |
          APP_JSON="$(curl -sf \
            -H "Authorization: Bearer ${DO_TOKEN}" \
            "${DO_API}/apps/${DO_APP_ID}")"
          ACTIVE_SHA="$(echo "$APP_JSON" | python3 -c "
          import json, sys
          app = json.load(sys.stdin).get('app', {})
          dep = app.get('active_deployment') or {}
          svcs = dep.get('services') or []
          print((svcs[0].get('source_commit_hash') or '').strip() if svcs else '')
          " 2>/dev/null || echo "")"
          echo "active_sha=$ACTIVE_SHA" >> "$GITHUB_OUTPUT"
          if [ "$ACTIVE_SHA" = "${GITHUB_SHA}" ] && [ "${{ inputs.force_rebuild }}" != "true" ]; then
            echo "skip_deploy=true" >> "$GITHUB_OUTPUT"
            echo "Skip: SHA already active (${ACTIVE_SHA:0:7})"
          else
            echo "skip_deploy=false" >> "$GITHUB_OUTPUT"
            echo "Deploy: active=${ACTIVE_SHA:0:7} target=${GITHUB_SHA::7}"
          fi

      - name: Trigger DO deployment
        id: deploy
        if: steps.active.outputs.skip_deploy != 'true'
        run: |
          BODY='{}'
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            BODY='{"force_build": true}'
          fi
          DEPLOY_ID=""
          for attempt in 1 2 3; do
            echo "attempt ${attempt}/3 at $(date -u +%H:%M:%S)"
            RESP="$(curl -sf -X POST \
              -H "Authorization: Bearer ${DO_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$BODY" \
              "${DO_API}/apps/${DO_APP_ID}/deployments" 2>/tmp/do-deploy.err || true)"
            if [ -n "$RESP" ]; then
              DEPLOY_ID="$(echo "$RESP" | python3 -c "import json,sys; print(json.load(sys.stdin).get('deployment',{}).get('id',''))" 2>/dev/null || echo "")"
              [ -n "$DEPLOY_ID" ] && break
            fi
            sleep 3
          done
          if [ -z "$DEPLOY_ID" ]; then
            echo "::error::Deployment ID is empty"
            cat /tmp/do-deploy.err 2>/dev/null || true
            exit 1
          fi
          echo "deployment_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
          echo "Triggered deployment: $DEPLOY_ID"

      - name: Wait for ACTIVE
        if: steps.active.outputs.skip_deploy != 'true'
        run: |
          DEPLOY_ID="${{ steps.deploy.outputs.deployment_id }}"
          for i in $(seq 1 90); do
            PHASE="$(curl -sf \
              -H "Authorization: Bearer ${DO_TOKEN}" \
              "${DO_API}/apps/${DO_APP_ID}/deployments/${DEPLOY_ID}" \
              | python3 -c "import json,sys; print(json.load(sys.stdin).get('deployment',{}).get('phase','').lower())" 2>/dev/null || echo "")"
            [ -z "$PHASE" ] && PHASE="unknown"
            echo "poll ${i}/90: phase=$PHASE"
            case "$PHASE" in
              active) echo "Deployment ACTIVE"; exit 0 ;;
              error|canceled|superseded) echo "::error::Terminal phase: $PHASE"; exit 1 ;;
            esac
            sleep 10
          done
          echo "::error::Timeout waiting for deployment"; exit 1

      - name: Resolve production URL
        id: app
        run: |
          URL="$(curl -sf \
            -H "Authorization: Bearer ${DO_TOKEN}" \
            "${DO_API}/apps/${DO_APP_ID}" \
            | python3 -c "import json,sys; print(json.load(sys.stdin).get('app',{}).get('default_ingress','').strip())" 2>/dev/null || echo "")"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "Production URL: $URL"

      - name: Health check
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          BASE="${{ steps.app.outputs.url }}"
          BASE="${BASE%/}"
          if [ -z "$BASE" ]; then
            echo "::error::Production URL is empty — cannot run health check"
            exit 1
          fi
          # Liveness check (required)
          for i in $(seq 1 60); do
            if curl -fsS --max-time 5 "$BASE/api/health" >/dev/null 2>&1; then
              echo "Liveness OK in $((i*2))s"
              break
            fi
            sleep 2
          done
          if ! curl -fsS --max-time 5 "$BASE/api/health" >/dev/null 2>&1; then
            echo "::error::Liveness check failed after 120s"
            exit 1
          fi
          # Deep health check (optional — warn only)
          if [ -n "${CRON_SECRET:-}" ]; then
            if curl -fsS --max-time 8 \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              "$BASE/api/health/deep" >/dev/null 2>&1; then
              echo "Deep health OK"
            else
              echo "::warning::Deep health check failed (CRON_SECRET mismatch or DB issue). Liveness passed — deploy continues."
            fi
          else
            echo "Deep health auth secret unavailable, skipping."
          fi
          echo "Health check passed"

      - name: Verify deployed commit
        run: |
          APP_JSON="$(curl -sf \
            -H "Authorization: Bearer ${DO_TOKEN}" \
            "${DO_API}/apps/${DO_APP_ID}")"
          echo "$APP_JSON" | python3 -c "
          import json, sys
          app = json.load(sys.stdin).get('app', {})
          dep = app.get('active_deployment') or {}
          svcs = dep.get('services') or []
          sha = (svcs[0].get('source_commit_hash') or '').strip() if svcs else ''
          expected = '${GITHUB_SHA}'.strip()
          if sha != expected:
              print(f'ERROR: mismatch expected={expected[:7]} actual={sha[:7]}', file=sys.stderr)
              sys.exit(1)
          print(f'OK: verified ({sha[:7]})')
          "

      - name: Summary
        if: always()
        run: |
          BASE="${{ steps.app.outputs.url }}"
          BASE="${BASE%/}"
          {
            echo "## Deploy"
            echo "| Key | Value |"
            echo "|-----|-------|"
            echo "| URL | ${BASE} |"
            echo "| Commit | \`${GITHUB_SHA::7}\` |"
            echo "| Deploy ID | \`${{ steps.deploy.outputs.deployment_id || 'already-active' }}\` |"
            echo "| Force | ${{ inputs.force_rebuild }} |"
          } >> "$GITHUB_STEP_SUMMARY"
